#!/usr/bin/env python

from idautils import *
from idc import *
import function

def deobfchunks():
    for a in Heads():
        if GuessType(a) != 'obfchunk':
            continue

        upper_size = Byte(a+1)
        lower_size = Byte(a+2)
        size = (upper_size << 8) + lower_size

        if size == 0:
            continue

        blist = map(lambda x: Byte(a+0x26+x), range(size))
        key = 0x10
        for i in range(len(blist)):
            tmp = blist[i]
            newkey = tmp
            tmp ^= key
            blist[i] = tmp
            key = newkey
            
        blist = filter(lambda x: x != 0, blist)
        deobf = ''.join(map(chr, blist))
        print deobf
        MakeRptCmt(a, deobf)

        for ref in DataRefsTo(a):
            MakeComm(ref, deobf)
